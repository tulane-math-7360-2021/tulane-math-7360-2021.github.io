---
title: "Data transformation"
author: "Dr. Xiang Ji @ Tulane University"
date: "Oct 13, 2021"
output:
  html_document:
    toc: true
    toc_depth: 4  
subtitle: MATH-7360 Data Analysis
csl: ../apa.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = 'center')
```


## Acknowledgement

Dr. Hua Zhou's [slides](https://ucla-biostat203b-2020winter.github.io/slides/07-dplyr/dplyr.html)


```{r}
rm(list = ls()) # clean-up workspace
library("tidyverse")
library("nycflights13")
```

# Combine tables | r4ds chapter 13

nycflights13 package has >1 tables:

- We already know a lot about flights:
    ```{r}
    flights %>% print(width = Inf)
    ```

----

- airlines:
    ```{r}
    airlines
    ```

----

- airports:
    ```{r}
    airports
    ```

----

- planes:
    ```{r}
    planes
    ```

----

- Weather:
    ```{r}
    weather
    ```

## Relational data

<p align="center">
<img src="./relational-nycflights.png" height="375">
</p>

## Keys

- A **primary key** uniquely identifies an observation in its own table.

    - single variable, e.g., `tailnum` for each plane
    
    - multiple variables, e.g., `year`, `month`, `day`, `hour`, and `origin` to identify an observation in `weather`

- A **foreign key** uniquely identifies an observation in another table.

Good practice: verify the primary keys by using `count()`

```{r}
planes %>% 
  count(tailnum) %>% 
  filter(n > 1)

weather %>% 
  count(year, month, day, hour, origin) %>% 
  filter(n > 1)
```

# Combine variables (columns)

## Demo tables

-
    ```{r}
    (x <- tribble(
      ~key, ~val_x,
         1, "x1",
         2, "x2",
         3, "x3"
    ))
    ```
    ```{r}
    (y <- tribble(
      ~key, ~val_y,
         1, "y1",
         2, "y2",
         4, "y3"
    ))
    ```

## Inner join

- An **inner join** matches pairs of observations whenever their keys are equal:

<p align="center">
<img src="./join-inner.png" height="150">
</p>

- 
    ```{r}
    inner_join(x, y, by = "key")
    ```
Same as
    ```{r, eval = FALSE}
    x %>% inner_join(y, by = "key")
    ```

Generally not appropriate for use because of loss of observations

## Outer join

- An **outer join** keeps observations that appear in at least one of the tables. 

- Three types of outer joins:

    - A **left join** keeps all observations in `x`.
    ```{r}
    left_join(x, y, by = "key")
    ```

    - A **right join** keeps all observations in `y`.
    ```{r}
    right_join(x, y, by = "key")
    ```
    
    - A **full join** keeps all observations in `x` or `y`.
    ```{r}
    full_join(x, y, by = "key")
    ```
    
    <p align="center">
    <img src="./join-outer.png" height="275">
    </p>
    
## Duplicate keys

- One table has duplicate keys.

    <p align="center">
    <img src="./join-one-to-many.png" height="200">
    </p>
    
----    

- 
    ```{r}
    x <- tribble(
      ~key, ~val_x,
         1, "x1",
         2, "x2",
         2, "x3",
         1, "x4"
    )
    y <- tribble(
      ~key, ~val_y,
         1, "y1",
         2, "y2"
    )
    left_join(x, y, by = "key")
    ```

----

- Both tables have duplicate keys. You get all possible combinations, the Cartesian product:

    <p align="center">
    <img src="./join-many-to-many.png" height="250">
    </p>

----

- 
    ```{r}
    x <- tribble(
      ~key, ~val_x,
         1, "x1",
         2, "x2",
         2, "x3",
         3, "x4"
    )
    y <- tribble(
      ~key, ~val_y,
         1, "y1",
         2, "y2",
         2, "y3",
         3, "y4"
    )
    left_join(x, y, by = "key")
    ```

----

- Let's create a narrower table from the flights data:
    ```{r}
    flights2 <- flights %>% 
      select(year:day, hour, origin, dest, tailnum, carrier)
    flights2
    ```

- We want to merge with the `weather` table:
    ```{r}
    weather
    ```

## Defining the key columns

- `by = NULL` (default): use all variables that appear in both tables:
    ```{r}
    # same as: flights2 %>% left_join(weather)
    left_join(flights2, weather)
    ```

----

- `by = "x"`: use the common variable `x`:
    ```{r}
    # same as: flights2 %>% left_join(weather)
    left_join(flights2, planes, by = "tailnum")
    ```

----

- `by = c("a" = "b")`: match variable `a` in table `x` to the variable `b` in table `y`.
    ```{r}
    # same as: flights2 %>% left_join(weather)
    left_join(flights2, airports, by = c("dest" = "faa"))
    ```

# Combine cases (rows)

----

- Top 10 most popular destinations:
    ```{r}
    top_dest <- flights %>%
      count(dest, sort = TRUE) %>%
      head(10)
    top_dest
    ```
    
- How to filter the cases that fly to these destinations?     
    
## Semi-join

- `semi_join(x, y)` keeps the rows in `x` that have a match in `y`.

    <p align="center">
    <img src="./join-semi.png" height="200">
    </p>

- Useful to see what will be joined.

----

-
    ```{r}
    semi_join(flights, top_dest)
    ```

## Anti-join

- `anti_join(x, y)` keeps the rows that donâ€™t have a match.

    <p align="center">
    <img src="./join-anti.png" height="200">
    </p>

- Useful to see what will not be joined.

----

-
    ```{r}
    flights %>% 
      anti_join(planes, by = "tailnum") %>%
      count(tailnum, sort = TRUE)
    ```

## Set operations

1. All these operations work with a complete row, comparing the values of every variable.

2. These operations expect the `x` and `y` inputs to have the same variables.


- Generate two tables:
    ```{r}
    (df1 <- tribble(
      ~x, ~y,
       1,  1,
       2,  1
    ))
    ```
    ```{r}
    (df2 <- tribble(
      ~x, ~y,
       1,  1,
       1,  2
    ))
    ```

----

- `bind_rows(x, y)` stacks table `x` on top of `y`. 
    ```{r}
    bind_rows(df1, df2)
    ```

- `intersect(x, y)` returns rows that appear in both `x` and `y`.
    ```{r}
    intersect(df1, df2)
    ```

----

- `union(x, y)` returns unique observations in `x` and `y`.
    ```{r}
    union(df1, df2)
    ```

----

- `setdiff(x, y)` returns rows that appear in `x` but not in `y`.
    ```{r}
    setdiff(df1, df2)
    ```
    ```{r}
    setdiff(df2, df1)
    ```
    
## Cheat sheet  

[RStudio cheat sheet](https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf) is extremely helpful.
